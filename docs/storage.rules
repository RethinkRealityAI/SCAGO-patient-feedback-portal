rules_version = '2';

// Firebase Storage Security Rules
service firebase.storage {
  match /b/{bucket}/o {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is admin (using custom claims like Firestore)
    function isAdmin() {
      return isAuthenticated() &&
             (request.auth.token.role == 'admin' || request.auth.token.role == 'super-admin');
    }

    // Helper function to check if user is YEP Manager
    function isYEPManager() {
      return isAuthenticated() &&
             request.auth.token.role == 'yep-manager';
    }

    // Helper function to check if user is admin or YEP Manager
    function isAdminOrYEPManager() {
      return isAdmin() || isYEPManager();
    }

    // YEP Files - Admin, YEP Manager, or record owner can read/write
    // Path structure: yep-files/participants/{participantId}/{fileName} or yep-files/mentors/{mentorId}/{fileName}
    match /yep-files/participants/{participantId}/{allPaths=**} {
      // Admins and YEP Managers have full access
      allow read, write: if isAdminOrYEPManager();

      // Participants can manage their own files (check both userId and authEmail)
      allow read, write: if isAuthenticated() &&
                            exists(/databases/(default)/documents/yep_participants/$(participantId)) &&
                            (firestore.get(/databases/(default)/documents/yep_participants/$(participantId)).data.userId == request.auth.uid ||
                             firestore.get(/databases/(default)/documents/yep_participants/$(participantId)).data.authEmail == request.auth.token.email);
    }

    match /yep-files/mentors/{mentorId}/{allPaths=**} {
      // Admins and YEP Managers have full access
      allow read, write: if isAdminOrYEPManager();

      // Mentors can manage their own files (check both userId and authEmail)
      allow read, write: if isAuthenticated() &&
                            exists(/databases/(default)/documents/yep_mentors/$(mentorId)) &&
                            (firestore.get(/databases/(default)/documents/yep_mentors/$(mentorId)).data.userId == request.auth.uid ||
                             firestore.get(/databases/(default)/documents/yep_mentors/$(mentorId)).data.authEmail == request.auth.token.email);
    }

    // Legacy YEP files path (backwards compatibility) - Admin or YEP Manager only
    // This path is used by admin uploads when creating/editing participant/mentor profiles
    match /yep-files/{fileName} {
      allow read, write: if isAdminOrYEPManager();
    }

    // Survey Files - Admin can read/write, public can read
    match /survey-files/{allPaths=**} {
      allow read: if true;  // Public read access for survey files
      allow write: if isAdmin();  // Only admins can upload survey files
    }

    // Feedback Files - Anyone can upload (create/update), only admin can read/delete
    match /feedback-files/{allPaths=**} {
      allow read: if isAdmin();
      // Non-admin may create/update (request.resource != null). Admin may perform any write, including deletes
      allow write: if (isAuthenticated() && request.resource != null) || isAdmin();
    }

    // Profile Images - Authenticated users can read/write their own
    match /profile-images/{userId}/{allPaths=**} {
      allow read: if true;  // Public read access
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Temporary uploads - Auth users can create/update, admin can delete
    match /temp/{allPaths=**} {
      allow read: if isAuthenticated();
      // create/update by authenticated users, delete by admin (request.resource == null)
      allow write: if (isAuthenticated() && request.resource != null) || (isAdmin() && request.resource == null);
    }
    
    // Patient Documents - Admin only
    match /patient-documents/{patientId}/{allPaths=**} {
      // Only admins can read and write patient documents
      allow read, write: if isAdmin();
    }

    // Survey Submission Attachments - Public upload, Admin read
    // Path structure: submissions/{surveyId}/{sessionId}/{timestamp}_{filename}
    match /submissions/{surveyId}/{sessionId}/{filename} {
      // Only admins can read or delete submission attachments
      allow read, delete: if isAdmin();
      
      // Anyone can upload (create) attachments for a survey submission
      // We restrict size to 10MB per file and specific allowed types
      allow create: if request.resource.size < 10 * 1024 * 1024 &&
                      (request.resource.contentType.matches('image/.*') || 
                       request.resource.contentType == 'application/pdf' ||
                       request.resource.contentType == 'application/msword' ||
                       request.resource.contentType == 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
                       request.resource.contentType == 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                       request.resource.contentType == 'application/vnd.ms-excel' ||
                       request.resource.contentType == 'text/plain');
      
      // Updates are not allowed for public users, only internal admin if needed
      allow update: if isAdmin();
    }
  }
}
